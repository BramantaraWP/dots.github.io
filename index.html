<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dot. | Intelligence Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <style>
        :root {
            --bg-paper: #ffffff;
            --accent: #000000;
            --accent-red: #e11d48;
            --text-main: #18181b;
            --text-muted: #71717a;
            --border: #e4e4e7;
            --font-news: 'Playfair Display', serif;
            --font-ui: 'Inter', sans-serif;
        }

        [data-theme="dark"] {
            --bg-paper: #0a0a0b;
            --text-main: #f4f4f5;
            --border: #27272a;
            --accent: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--bg-paper); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .truncate-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .top-bar { border-bottom: 1px solid var(--border); padding: 10px 2rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; font-weight: 700; }
        header { padding: 2rem 1rem; text-align: center; border-bottom: 4px double var(--border); position: relative; }
        .logo { font-family: var(--font-news); font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; cursor: pointer; }

        nav#desktop-nav { 
            display: flex; justify-content: center; gap: 2rem; padding: 1rem; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; 
            background: var(--bg-paper); z-index: 100; font-size: 0.8rem; font-weight: 700;
        }
        nav span { cursor: pointer; transition: 0.2s; }
        nav span:hover { color: var(--accent-red); }

        .mobile-toggle { display: none; font-size: 1.5rem; cursor: pointer; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); }

        .mobile-nav {
            position: fixed; top: 0; left: -100%; width: 80%; max-width: 300px; height: 100%;
            background: var(--bg-paper); z-index: 2000; transition: 0.4s;
            padding: 2rem; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 1.5rem;
        }
        .mobile-nav.active { left: 0; }
        .nav-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999;
            display: none; backdrop-filter: blur(4px);
        }

        #viewer { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        .news-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2.5rem; }

        .hero-article { cursor: pointer; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border); position: relative; }
        .hero-article img { width: 100%; max-height: 450px; object-fit: cover; border-radius: 4px; margin-bottom: 1.5rem; }
        .hero-article h1 { font-family: var(--font-news); font-size: 2.8rem; line-height: 1.1; margin-bottom: 1rem; }

        .side-item { display: flex; gap: 1rem; cursor: pointer; padding-bottom: 1rem; border-bottom: 1px solid var(--border); margin-bottom: 1rem; position: relative; }
        .side-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .modal-card { background: var(--bg-paper); width: 100%; max-width: 450px; padding: 2.5rem; border-radius: 8px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        .btn-black { background: var(--accent); color: var(--bg-paper); border: none; padding: 12px 24px; font-weight: 700; cursor: pointer; width: 100%; border-radius: 4px; margin-top: 10px; text-transform: uppercase; transition: 0.2s; }
        .btn-black:hover { opacity: 0.8; }
        .btn-outline { background: transparent; color: var(--text-main); border: 1px solid var(--border); padding: 8px 16px; font-size: 0.7rem; font-weight: 700; cursor: pointer; border-radius: 4px; }

        input, select, textarea { width: 100%; border: 1px solid var(--border); padding: 12px; margin-bottom: 1rem; background: transparent; color: var(--text-main); font-family: var(--font-ui); border-radius: 4px; }

        .action-icon { position: absolute; right: 0; top: 0; padding: 5px; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .action-icon:hover { color: var(--accent-red); }

        /* Comment Section Styles */
        .comment-box { margin-top: 3rem; border-top: 4px solid var(--accent); padding-top: 2rem; }
        .comment-item { padding: 1.5rem 0; border-bottom: 1px solid var(--border); }
        .reply-item { margin-left: 2rem; padding: 1rem 0; border-left: 2px solid var(--border); padding-left: 1.5rem; margin-top: 10px; }

        #progress-bar { position: fixed; top: 0; left: 0; height: 4px; background: var(--accent-red); width: 0%; z-index: 2500; transition: width 0.3s; }

        @media (max-width: 768px) {
            .news-grid { grid-template-columns: 1fr; }
            nav#desktop-nav { display: none; }
            .mobile-toggle { display: block; }
            .logo { font-size: 2.2rem; }
            .hero-article h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body data-theme="light">

    <div id="progress-bar"></div>
    <div id="nav-overlay" class="nav-overlay" onclick="closeMobileMenu()"></div>

    <div id="mobile-nav" class="mobile-nav">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <div style="font-family:var(--font-news); font-weight:900; font-size:1.5rem;">NAVIGASI</div>
            <i class="fa-solid fa-xmark" onclick="closeMobileMenu()" style="cursor:pointer; font-size:1.5rem;"></i>
        </div>
        <span onclick="goHome(); closeMobileMenu()">UTAMA</span>
        <span onclick="filterCat('POLITIK'); closeMobileMenu()">POLITIK</span>
        <span onclick="filterCat('TEKNOLOGI'); closeMobileMenu()">TEKNOLOGI</span>
        <hr style="border:0; border-top:1px solid var(--border);">
        <span onclick="openEditor(); closeMobileMenu()" style="color:var(--accent-red)">+ TULIS BERITA</span>
        <span id="auth-btn-mob">SIGN IN</span>
    </div>

    <div class="top-bar">
        <div id="date-display">...</div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div style="cursor:pointer;" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i> TEMA</div>
        </div>
    </div>

    <header>
        <div class="mobile-toggle" onclick="openMenu()">
            <i class="fa-solid fa-bars-staggered"></i>
        </div>
        <div class="logo" onclick="goHome()">dot. Archive</div>
    </header>

    <nav id="desktop-nav">
        <span onclick="goHome()">UTAMA</span>
        <span onclick="filterCat('POLITIK')">POLITIK</span>
        <span onclick="filterCat('TEKNOLOGI')">TEKNOLOGI</span>
        <span onclick="openEditor()" style="color:var(--accent-red)">+ TULIS BERITA</span>
        <span id="auth-btn-desk">SIGN IN</span>
    </nav>

    <div id="viewer"></div>

    <div id="modal" class="modal-overlay" onclick="if(event.target.id==='modal') closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        const ENDPOINTS = { READ: "/api/read", UPLOAD: "/api/upload" };

        let db = [];
        let session = JSON.parse(localStorage.getItem('dot_session')) || null;
        let activeId = null;
        let currentFilter = 'ALL';

        const sanitize = (t) => { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        const cipher = {
            encode: (t) => btoa(unescape(encodeURIComponent(t))),
            decode: (s) => { try { return decodeURIComponent(escape(atob(s))); } catch(e) { return s; } }
        };

        function timeAgo(ts) {
            const diff = Math.floor((Date.now() - ts) / 1000);
            if (diff < 60) return 'Baru saja';
            if (diff < 3600) return `${Math.floor(diff/60)} menit lalu`;
            if (diff < 86400) return `${Math.floor(diff/3600)} jam lalu`;
            return new Date(ts).toLocaleDateString('id-ID', { day:'numeric', month:'short', year:'numeric' });
        }

        function openMenu() { document.getElementById('mobile-nav').classList.add('active'); document.getElementById('nav-overlay').style.display = 'block'; }
        function closeMobileMenu() { document.getElementById('mobile-nav').classList.remove('active'); document.getElementById('nav-overlay').style.display = 'none'; }

        async function loadData() {
            document.getElementById('progress-bar').style.width = '30%';
            try {
                const res = await fetch(ENDPOINTS.READ);
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const wraps = Array.from(doc.querySelectorAll('.tgme_widget_message'));

                db = wraps.map(w => {
                    const textEl = w.querySelector('.tgme_widget_message_text');
                    const imgEl = w.querySelector('.tgme_widget_message_photo_wrap');
                    let img = "";
                    if(imgEl) {
                        const m = imgEl.getAttribute('style').match(/url\(['"]?([^'"]+)['"]?\)/);
                        if(m) img = m[1];
                    }
                    const parts = (textEl ? textEl.innerText.trim() : "").split('::');
                    const ts = w.querySelector('time') ? new Date(w.querySelector('time').getAttribute('datetime')).getTime() : Date.now();
                    const linkEl = w.querySelector('.tgme_widget_message_date');
                    return { type: parts[0], parts, img, timestamp: ts, tgId: linkEl ? linkEl.getAttribute('href').split('/').pop() : null };
                }).reverse();
                document.getElementById('progress-bar').style.width = '100%';
                setTimeout(() => document.getElementById('progress-bar').style.width = '0%', 500);
                renderUI();
            } catch (e) { console.error("Sync error", e); }
        }

        function renderUI() {
            const viewer = document.getElementById('viewer');
            const topics = db.filter(x => x.type === 'TOPIC');
            
            const authText = session ? `LOGOUT (@${session.username.toUpperCase()})` : "SIGN IN";
            const authAction = session ? () => { localStorage.clear(); location.reload(); } : () => showAuthModal('login');
            document.getElementById('auth-btn-mob').innerText = authText;
            document.getElementById('auth-btn-mob').onclick = authAction;
            document.getElementById('auth-btn-desk').innerText = authText;
            document.getElementById('auth-btn-desk').onclick = authAction;

            if(activeId) {
                renderDetail(topics.find(t => t.parts[1] === activeId));
                return;
            }

            const filtered = currentFilter === 'ALL' ? topics : topics.filter(t => (t.parts[7] || 'GENERAL') === currentFilter);
            
            viewer.innerHTML = `
                <div class="news-grid">
                    <div class="hero-col">
                        ${filtered.length > 0 ? `
                        <div class="hero-article" onclick="activeId='${filtered[0].parts[1]}'; renderUI();">
                            ${filtered[0].img ? `<img src="${filtered[0].img}">` : ''}
                            <span style="color:var(--accent-red); font-size:0.75rem; font-weight:800;">${filtered[0].parts[7] || 'GENERAL'}</span>
                            <h1>${sanitize(filtered[0].parts[3])}</h1>
                            <p class="truncate-3" style="color:var(--text-muted); margin:1rem 0; line-height:1.6;">${sanitize(cipher.decode(filtered[0].parts[4]))}</p>
                            <div style="font-size:0.7rem; font-weight:800; border-top:1px solid var(--border); padding-top:10px; display:flex; justify-content:space-between;">
                                <span>BY ${filtered[0].parts[2].toUpperCase()} • ${timeAgo(parseInt(filtered[0].timestamp))}</span>
                                ${session && session.username === filtered[0].parts[2] ? `<i class="fa-solid fa-trash action-icon" onclick="event.stopPropagation(); hapusArtikel('${filtered[0].parts[1]}')"></i>` : ''}
                            </div>
                        </div>` : '<p>Belum ada berita...</p>'}
                    </div>
                    <div class="side-col">
                        ${filtered.slice(1).map(t => `
                            <div class="side-item" onclick="activeId='${t.parts[1]}'; renderUI();">
                                ${t.img ? `<img src="${t.img}">` : ''}
                                <div style="width:100%">
                                    <span style="color:var(--accent-red); font-size:0.6rem; font-weight:800;">${t.parts[7] || 'GENERAL'}</span>
                                    <h4 class="truncate-3" style="font-family:var(--font-news); font-size:1.1rem; line-height:1.2;">${sanitize(t.parts[3])}</h4>
                                    <div style="font-size:0.6rem; margin-top:5px; color:var(--text-muted)">${timeAgo(parseInt(t.timestamp))}</div>
                                </div>
                                ${session && session.username === t.parts[2] ? `<i class="fa-solid fa-trash action-icon" style="font-size:0.7rem;" onclick="event.stopPropagation(); hapusArtikel('${t.parts[1]}')"></i>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderDetail(t) {
            const comments = db.filter(x => x.type === 'CRITIC' && x.parts[1] === t.parts[1]);
            
            document.getElementById('viewer').innerHTML = `
                <div style="max-width:750px; margin:0 auto;">
                    <div style="text-align:center; margin-bottom:1rem;"><span class="btn-outline">${t.parts[7] || 'GENERAL'}</span></div>
                    <h1 style="font-family:var(--font-news); font-size:2.8rem; line-height:1.1; margin-bottom:1.5rem; text-align:center;">${sanitize(t.parts[3])}</h1>
                    <div style="display:flex; justify-content:center; gap:15px; font-size:0.8rem; color:var(--text-muted); margin-bottom:2rem; padding-bottom:1rem; border-bottom:1px solid var(--border);">
                        <span>BY ${t.parts[2].toUpperCase()}</span>
                        <span>•</span>
                        <span>${timeAgo(parseInt(t.timestamp))}</span>
                    </div>
                    ${t.img ? `<img src="${t.img}" style="width:100%; border-radius:4px; margin-bottom:2rem; border:1px solid var(--border);">` : ''}
                    <div style="font-family:var(--font-news); font-size:1.3rem; line-height:1.8; margin-bottom:4rem; white-space: pre-wrap;">
                        ${sanitize(cipher.decode(t.parts[4]))}
                    </div>
                    
                    <div class="comment-box">
                        <h3 style="font-family:var(--font-news); font-size:1.8rem; margin-bottom:1.5rem;">Diskusi & Kritik</h3>
                        ${session ? `
                            <textarea id="critMsg" placeholder="Tulis kritik atau saran Anda..." style="height:100px;"></textarea>
                            <button class="btn-black" onclick="submitCritic('${t.parts[1]}')">KIRIM KRITIK</button>
                        ` : '<p style="font-size:0.8rem; color:var(--text-muted); text-align:center;">Silakan Sign In untuk memberikan kritik.</p>'}
                        
                        <div style="margin-top:2rem;">
                            ${comments.map(c => {
                                const replies = db.filter(x => x.type === 'REPLY' && x.parts[2] === c.parts[2]); // Match by Critic ID
                                return `
                                <div class="comment-item">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <b style="font-size:0.8rem;">@${c.parts[3].toUpperCase()}</b>
                                        <span style="font-size:0.6rem; color:var(--text-muted);">${timeAgo(parseInt(c.timestamp))}</span>
                                    </div>
                                    <p style="margin:10px 0; font-size:0.95rem; line-height:1.5;">${sanitize(cipher.decode(c.parts[4]))}</p>
                                    ${session ? `<span style="font-size:0.7rem; color:var(--accent-red); font-weight:700; cursor:pointer;" onclick="openReplyForm('${t.parts[1]}','${c.parts[2]}')">BALAS</span>` : ''}
                                    
                                    ${replies.map(r => `
                                        <div class="reply-item">
                                            <div style="display:flex; justify-content:space-between;">
                                                <b style="font-size:0.7rem;">@${r.parts[3].toUpperCase()}</b>
                                                <span style="font-size:0.6rem; color:var(--text-muted);">${timeAgo(parseInt(r.timestamp))}</span>
                                            </div>
                                            <p style="margin-top:5px; font-size:0.9rem;">${sanitize(cipher.decode(r.parts[4]))}</p>
                                        </div>
                                    `).join('')}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                    
                    <button class="btn-black" onclick="goHome()" style="margin-top:3rem;">KEMBALI KE BERANDA</button>
                </div>
            `;
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        async function submitCritic(postId) {
            const msg = document.getElementById('critMsg').value;
            if(!msg) return;
            const critId = 'CR' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const text = `CRITIC::${postId}::${critId}::${session.username}::${cipher.encode(msg)}::${Date.now()}`;
            
            await fetch(ENDPOINTS.UPLOAD, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            loadData();
        }

        function openReplyForm(postId, critId) {
            const msg = prompt("Tulis balasan Anda:");
            if(!msg) return;
            const text = `REPLY::${postId}::${critId}::${session.username}::${cipher.encode(msg)}::${Date.now()}`;
            
            fetch(ENDPOINTS.UPLOAD, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            }).then(() => loadData());
        }

        async function hapusArtikel(postId) {
            if(!confirm("Njir, beneran mau hapus artikel ini?")) return;
            const text = `DELETE_REQ::${postId}::${session.username}::${Date.now()}`;
            
            try {
                await fetch(ENDPOINTS.UPLOAD, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                alert("Permintaan hapus terkirim! Artikel akan segera hilang dari arsip.");
                loadData();
            } catch(e) { alert("Gagal koneksi!"); }
        }

        // --- AUTH & EDITOR (UI Tetap Sama) ---
        function showAuthModal(mode) {
            document.getElementById('modal-content').innerHTML = `
                <h2 style="font-family:var(--font-news); margin-bottom:1.5rem; text-align:center;">${mode==='login'?'Sign In':'Register'}</h2>
                <input type="text" id="authU" placeholder="Username">
                <input type="password" id="authP" placeholder="Password">
                <button class="btn-black" onclick="${mode==='login'?'handleLogin()':'handleReg()'}">CONFIRM</button>
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        function handleLogin() {
            const u = document.getElementById('authU').value.trim().toLowerCase();
            const p = document.getElementById('authP').value;
            const user = db.find(x => x.type === 'USER' && x.parts[1] === u && x.parts[2] === p);
            if(user) { session = { username: u }; localStorage.setItem('dot_session', JSON.stringify(session)); location.reload(); }
            else alert("Identitas Salah!");
        }

        async function handleReg() {
            const u = document.getElementById('authU').value.trim().toLowerCase();
            const p = document.getElementById('authP').value;
            await fetch(ENDPOINTS.UPLOAD, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: `USER::${u}::${p}::${Date.now()}` })
            });
            session = { username: u }; localStorage.setItem('dot_session', JSON.stringify(session)); location.reload();
        }

        function openEditor() {
            if(!session) return showAuthModal('login');
            document.getElementById('modal-content').innerHTML = `
                <h2 style="font-family:var(--font-news); margin-bottom:1.5rem;">Tulis Berita</h2>
                <input type="text" id="edT" placeholder="Judul Berita">
                <select id="edCat"><option value="GENERAL">GENERAL</option><option value="POLITIK">POLITIK</option><option value="TEKNOLOGI">TEKNOLOGI</option></select>
                <textarea id="edC" placeholder="Konten..." style="height:150px;"></textarea>
                <input type="file" id="edF" accept="image/*">
                <button class="btn-black" id="pub-btn" onclick="submitTopic()">PUBLISH</button>
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        async function compressImage(file) {
            return new Promise((res) => {
                const r = new FileReader(); r.readAsDataURL(file);
                r.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const can = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if(w > 1000) { h *= 1000/w; w = 1000; }
                        can.width = w; can.height = h;
                        can.getContext('2d').drawImage(img, 0, 0, w, h);
                        can.toBlob(b => res(b), 'image/jpeg', 0.6);
                    };
                };
            });
        }

        async function submitTopic() {
            const t = sanitize(document.getElementById('edT').value);
            const c = document.getElementById('edC').value;
            const f = document.getElementById('edF').files[0];
            if(!t || !c) return alert("Isi semua!");
            
            const btn = document.getElementById('pub-btn');
            btn.disabled = true; btn.innerText = "SENDING...";
            
            const id = 'ID' + Math.random().toString(36).substr(2, 6).toUpperCase();
            const cap = `TOPIC::${id}::${session.username}::${t}::${cipher.encode(c)}::null::${Date.now()}::${document.getElementById('edCat').value}`;

            try {
                if(f) {
                    const blob = await compressImage(f);
                    const fd = new FormData(); fd.append('photo', blob, 'img.jpg'); fd.append('caption', cap);
                    await fetch(ENDPOINTS.UPLOAD, { method: 'POST', body: fd });
                } else {
                    await fetch(ENDPOINTS.UPLOAD, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({text: cap}) });
                }
                closeModal(); loadData();
            } catch(e) { alert("Error!"); btn.disabled = false; }
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function goHome() { activeId = null; currentFilter = 'ALL'; renderUI(); }
        function filterCat(c) { activeId = null; currentFilter = c; renderUI(); }
        function toggleTheme() {
            const b = document.body;
            b.setAttribute('data-theme', b.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
        }

        // Set Real Date
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        loadData();
    </script>
</body>
</html>

